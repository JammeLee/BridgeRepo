using System.Collections;
using System.Runtime.Remoting.Channels;
using System.Runtime.Remoting.Contexts;
using System.Runtime.Serialization;
using System.Security.Permissions;
using System.Threading;

namespace System.Runtime.Remoting.Messaging
{
	[Serializable]
	internal class TransitionCall : IMessage, IInternalMessage, IMessageSink, ISerializable
	{
		private IDictionary _props;

		private IntPtr _sourceCtxID;

		private IntPtr _targetCtxID;

		private int _targetDomainID;

		private ServerIdentity _srvID;

		private Identity _ID;

		private CrossContextDelegate _delegate;

		private IntPtr _eeData;

		public IDictionary Properties
		{
			get
			{
				if (_props == null)
				{
					lock (this)
					{
						if (_props == null)
						{
							_props = new Hashtable();
						}
					}
				}
				return _props;
			}
		}

		ServerIdentity IInternalMessage.ServerIdentityObject
		{
			get
			{
				if (_targetDomainID != 0 && _srvID == null)
				{
					lock (this)
					{
						Context contextInternal = Thread.GetContextInternal(_targetCtxID);
						if (contextInternal == null)
						{
							contextInternal = Context.DefaultContext;
						}
						_srvID = new ServerIdentity(null, Thread.GetContextInternal(_targetCtxID));
						_srvID.RaceSetServerObjectChain(this);
					}
				}
				return _srvID;
			}
			set
			{
				throw new RemotingException(Environment.GetResourceString("Remoting_Default"));
			}
		}

		Identity IInternalMessage.IdentityObject
		{
			get
			{
				return _ID;
			}
			set
			{
				throw new RemotingException(Environment.GetResourceString("Remoting_Default"));
			}
		}

		public IMessageSink NextSink => null;

		internal TransitionCall(IntPtr targetCtxID, CrossContextDelegate deleg)
		{
			_sourceCtxID = Thread.CurrentContext.InternalContextID;
			_targetCtxID = targetCtxID;
			_delegate = deleg;
			_targetDomainID = 0;
			_eeData = IntPtr.Zero;
			_srvID = new ServerIdentity(null, Thread.GetContextInternal(_targetCtxID));
			_ID = _srvID;
			_ID.RaceSetChannelSink(CrossContextChannel.MessageSink);
			_srvID.RaceSetServerObjectChain(this);
		}

		internal TransitionCall(IntPtr targetCtxID, IntPtr eeData, int targetDomainID)
		{
			_sourceCtxID = Thread.CurrentContext.InternalContextID;
			_targetCtxID = targetCtxID;
			_delegate = null;
			_targetDomainID = targetDomainID;
			_eeData = eeData;
			_srvID = null;
			_ID = new Identity("TransitionCallURI", null);
			CrossAppDomainData data = new CrossAppDomainData(_targetCtxID, _targetDomainID, Identity.ProcessGuid);
			string objectURI;
			IMessageSink channelSink = CrossAppDomainChannel.AppDomainChannel.CreateMessageSink(null, data, out objectURI);
			_ID.RaceSetChannelSink(channelSink);
		}

		internal TransitionCall(SerializationInfo info, StreamingContext context)
		{
			if (info == null || context.State != StreamingContextStates.CrossAppDomain)
			{
				throw new ArgumentNullException("info");
			}
			_props = (IDictionary)info.GetValue("props", typeof(IDictionary));
			_delegate = (CrossContextDelegate)info.GetValue("delegate", typeof(CrossContextDelegate));
			_sourceCtxID = (IntPtr)info.GetValue("sourceCtxID", typeof(IntPtr));
			_targetCtxID = (IntPtr)info.GetValue("targetCtxID", typeof(IntPtr));
			_eeData = (IntPtr)info.GetValue("eeData", typeof(IntPtr));
			_targetDomainID = info.GetInt32("targetDomainID");
		}

		void IInternalMessage.SetURI(string uri)
		{
			throw new RemotingException(Environment.GetResourceString("Remoting_Default"));
		}

		void IInternalMessage.SetCallContext(LogicalCallContext callContext)
		{
			throw new RemotingException(Environment.GetResourceString("Remoting_Default"));
		}

		bool IInternalMessage.HasProperties()
		{
			throw new RemotingException(Environment.GetResourceString("Remoting_Default"));
		}

		public IMessage SyncProcessMessage(IMessage msg)
		{
			try
			{
				LogicalCallContext oldcctx = Message.PropagateCallContextFromMessageToThread(msg);
				if (_delegate != null)
				{
					_delegate();
				}
				else
				{
					CallBackHelper @object = new CallBackHelper(_eeData, bFromEE: true, _targetDomainID);
					CrossContextDelegate crossContextDelegate = @object.Func;
					crossContextDelegate();
				}
				Message.PropagateCallContextFromThreadToMessage(msg, oldcctx);
				return this;
			}
			catch (Exception e)
			{
				ReturnMessage returnMessage = new ReturnMessage(e, new ErrorMessage());
				returnMessage.SetLogicalCallContext((LogicalCallContext)msg.Properties[Message.CallContextKey]);
				return returnMessage;
			}
		}

		public IMessageCtrl AsyncProcessMessage(IMessage msg, IMessageSink replySink)
		{
			IMessage msg2 = SyncProcessMessage(msg);
			replySink.SyncProcessMessage(msg2);
			return null;
		}

		[SecurityPermission(SecurityAction.LinkDemand, Flags = SecurityPermissionFlag.SerializationFormatter)]
		public void GetObjectData(SerializationInfo info, StreamingContext context)
		{
			if (info == null || context.State != StreamingContextStates.CrossAppDomain)
			{
				throw new ArgumentNullException("info");
			}
			info.AddValue("props", _props, typeof(IDictionary));
			info.AddValue("delegate", _delegate, typeof(CrossContextDelegate));
			info.AddValue("sourceCtxID", _sourceCtxID);
			info.AddValue("targetCtxID", _targetCtxID);
			info.AddValue("targetDomainID", _targetDomainID);
			info.AddValue("eeData", _eeData);
		}
	}
}
